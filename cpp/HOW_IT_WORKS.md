# Как работает программа: Добавление HDD в базу данных

## Архитектура системы

```
┌─────────────────┐         HTTP POST         ┌──────────────┐
│                 │    ────────────────────>   │              │
│ HDD Collector   │                            │   Flask      │
│  (Клиент)       │                            │   Server     │
│                 │    <────────────────────   │              │
│                 │      Ответ (JSON)          │              │
└─────────────────┘                            └──────────────┘
                                                       │
                                                       │ SQL запросы
                                                       ▼
                                                ┌──────────────┐
                                                │    База      │
                                                │   данных     │
                                                └──────────────┘
```

## Процесс работы

### 1. Сбор данных (Клиент)

Программа `HDDCollector` (C++ или Python версия):

- ✅ Сканирует систему через WMI
- ✅ Собирает информацию о **всех** физических дисках
- ✅ Формирует JSON с данными о дисках

**Что собирается:**
- Модель диска
- Серийный номер (уникальный идентификатор)
- Объем в ГБ
- Производитель
- Интерфейс (SATA, SAS, NVMe)
- Тип носителя
- Hostname компьютера
- Timestamp

### 2. Отправка на сервер

Программа отправляет HTTP POST запрос на:
```
POST http://<server>:<port>/api/hdd_collect
Content-Type: application/json

{
  "hostname": "PC-NAME",
  "timestamp": "2025-11-22T15:30:00",
  "platform": "Windows-10-10.0.19041-SP0",
  "disks": [
    {
      "model": "WD5003ABYX",
      "serial_number": "WMAYP3205431",
      "size_gb": 500,
      ...
    },
    {
      "model": "Samsung SSD 850",
      "serial_number": "S2HN123456",
      "size_gb": 250,
      ...
    }
  ]
}
```

### 3. Обработка на сервере (Flask)

Сервер должен:

1. **Получить данные** из POST запроса
2. **Для каждого диска:**
   - Проверить, существует ли диск в базе (по `serial_number`)
   - Если **НЕ существует** → создать новую запись (INSERT)
   - Если **существует** → обновить существующую запись (UPDATE)
3. **Вернуть ответ:**
```json
{
  "processed": 2,
  "total": 2,
  "new": 1,
  "updated": 1
}
```

## Ответ на вопрос: Добавляет ли программа новые HDD?

### ❌ Нет, напрямую не добавляет

Программа **НЕ управляет базой данных напрямую**. Она только:
- Собирает информацию о дисках
- Отправляет её на сервер

### ✅ Да, через сервер

Сервер получает данные и:
- **Добавляет новые диски** (если их нет в базе)
- **Обновляет существующие** (если они уже есть)

## Пример работы

### Сценарий 1: Первый запуск

1. На компьютере 2 диска: Disk1 и Disk2
2. Программа собирает информацию о обоих
3. Отправляет на сервер
4. Сервер добавляет оба диска в базу

**Результат:** 2 новых диска в базе

### Сценарий 2: Повторный запуск

1. На компьютере те же 2 диска
2. Программа собирает информацию
3. Отправляет на сервер
4. Сервер находит диски в базе (по serial_number)
5. Обновляет их информацию (timestamp, возможно изменились другие параметры)

**Результат:** 0 новых дисков, 2 обновлены

### Сценарий 3: Добавлен новый диск

1. На компьютере было 2 диска, теперь 3 (добавили Disk3)
2. Программа собирает информацию о **всех 3 дисках**
3. Отправляет на сервер все 3 диска
4. Сервер:
   - Disk1 и Disk2 → обновляет (уже есть в базе)
   - Disk3 → добавляет новый

**Результат:** 1 новый диск, 2 обновлены

### Сценарий 4: Диск убран

1. На компьютере было 3 диска, теперь 2 (убрали Disk3)
2. Программа собирает информацию только о **2 оставшихся дисках**
3. Отправляет на сервер только 2 диска
4. Сервер обновляет информацию о Disk1 и Disk2

**Важно:** Disk3 **не удаляется** из базы данных (программа не отправляет информацию о его удалении). Это нормальное поведение - диск просто не будет обновляться.

## Что нужно реализовать на сервере

Сервер должен иметь endpoint `/api/hdd_collect`, который:

```python
@app.route('/api/hdd_collect', methods=['POST'])
def hdd_collect():
    data = request.json
    
    hostname = data.get('hostname')
    disks = data.get('disks', [])
    
    new_count = 0
    updated_count = 0
    
    for disk_data in disks:
        serial = disk_data.get('serial_number')
        
        # Проверяем, существует ли диск в базе
        existing_disk = Disk.query.filter_by(serial_number=serial).first()
        
        if existing_disk:
            # Обновляем существующий диск
            existing_disk.model = disk_data.get('model')
            existing_disk.size_gb = disk_data.get('size_gb')
            # ... другие поля
            existing_disk.last_seen = datetime.now()
            updated_count += 1
        else:
            # Создаем новый диск
            new_disk = Disk(
                serial_number=serial,
                model=disk_data.get('model'),
                size_gb=disk_data.get('size_gb'),
                hostname=hostname,
                # ... другие поля
            )
            db.session.add(new_disk)
            new_count += 1
    
    db.session.commit()
    
    return jsonify({
        'processed': new_count + updated_count,
        'total': len(disks),
        'new': new_count,
        'updated': updated_count
    }), 200
```

## Итого

- ✅ Программа **отправляет данные** обо всех дисках на сервер
- ✅ Сервер **добавляет новые** диски в базу
- ✅ Сервер **обновляет существующие** диски
- ❌ Программа **не управляет** базой данных напрямую

Программа работает как **агент сбора данных**, а сервер - как **хранилище и обработчик данных**.

